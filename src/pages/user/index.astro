---
export const prerender = false;
import GalaxyLayout from "@/layouts/GalaxyLayout.astro";
import { MenuName } from "@/components/navbar/WorkNavbar.astro";
import BackButton from "@/components/custom-ui/BackButton";
import GalaxyAutoZoom from "@/components/all-stars/GalaxyAutoZoom";
import UserProfileWithBlogs from "@/components/user/UserProfileWithBlogs";
import CreateBlogCTA from "@/components/blog/CreateBlogCTA";
import { getUserById, getUserByEmail } from "@/server-side/user";
import { getGalaxiesByMaintainer } from "@/server-side/galaxy";
import { getBlogsByAuthor } from "@/server-side/blog";
import { mockUserStars } from "@/types/mock-data";

// Get user identifier from query params
const userIdParam = Astro.url.searchParams.get("id");
const userEmailParam = Astro.url.searchParams.get("email");

let user = null;

// Try to get user by ID or email
if (userIdParam) {
    console.log("user id param", userIdParam);
    user = await getUserById(userIdParam);
    console.log("user by id", user);
} else if (userEmailParam) {
    user = await getUserByEmail(userEmailParam);
    console.log("user by email", user);
} else {
    // Try to get current user from demo cookies (server-side fallback)
    const demoEmail = Astro.cookies.get("demo-email")?.value;
    if (demoEmail) {
        user = await getUserByEmail(demoEmail);
        console.log("user by demo email", user);
    } else {
        console.log("no user found");
    }
}

// If no user found, redirect to 404
if (!user) {
    return Astro.redirect("/user/404");
}

// Get user's galaxies (where user is maintainer)
const userGalaxies = await getGalaxiesByMaintainer(user._id!);

// Get user's blogs
const userBlogs = await getBlogsByAuthor(user._id!);

// Prepare galaxies for display in the virtual screen
const allGalaxies = userGalaxies.map((galaxy, index) => ({
    x: galaxy.x,
    y: galaxy.y,
    projectName: galaxy.name,
    projectId: galaxy._id?.toString() || "",
    galaxyData: galaxy,
    tags: galaxy.tags,
    leaderboardPosition: index + 1,
}));

// Calculate center position for user (average of their galaxies, or default to 0,0)
const userX =
    userGalaxies.length > 0
        ? userGalaxies.reduce((sum, g) => sum + g.x, 0) / userGalaxies.length
        : 0;
const userY =
    userGalaxies.length > 0
        ? userGalaxies.reduce((sum, g) => sum + g.y, 0) / userGalaxies.length
        : 0;
---

<GalaxyLayout
    active={MenuName.ProjectName}
    hideLinks={Object.keys(MenuName)}
    projectName={user.nickname || "User Profile"}
    stars={mockUserStars}
    projectGoal={1000}
    projectX={userX}
    projectY={userY}
    projectGalaxies={allGalaxies}
>
    <BackButton slot="left" client:load />

    <UserProfileWithBlogs
        slot="center"
        user={user}
        galaxies={userGalaxies}
        blogs={userBlogs}
        client:only="react"
    />

    <CreateBlogCTA slot="center" authorId={user._id!} client:only="react" />

    <GalaxyAutoZoom client:only="react" galaxyX={userX} galaxyY={userY} />
</GalaxyLayout>

<style is:global>
    /* Hide scrollbars but allow scrolling */
    html,
    body {
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
    }

    html::-webkit-scrollbar,
    body::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
    }

    /* Hide scrollbars on all elements */
    * {
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
    }

    *::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
    }
</style>
