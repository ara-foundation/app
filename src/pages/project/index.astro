---
import GalaxyLayout from "@/layouts/GalaxyLayout.astro";
import { MenuName } from "@/components/navbar/WorkNavbar.astro";

import { ProjectInfoProps } from "@/components/project/ProjectLink";
import ProjectLandingHero from "@/components/project/ProjectLandingHero";
import ProjectCTAPanel from "@/components/project/ProjectCTAPanel";
import PlaceCtaPanel from "@/components/project/PlaceCtaPanel";
import ProjectGoalPanel from "@/components/project/ProjectGoalPanel";
// import ProjectPeople from "@/components/project/ProjectPeoplePanel";
// import HighlightedInteraction from "@/components/project/HighlightedInteractionPanel";
import BackButton from "@/components/custom-ui/BackButton";
import AllStarsContest from "@/components/all-stars/AllStarsContest";
import { getGalaxySpace, getUserStar } from "@/server-side/all-stars";
import { getGalaxyById } from "@/server-side/galaxy";
import { getProjectById } from "@/server-side/project";
import { getStarById, getStarByUserId } from "@/server-side/star";
import { getAuthUserById } from "@/server-side/auth";
import type { UserStar } from "@/types/all-stars";
import type { AuthUser } from "@/types/auth";

// Get galaxy ID from query parameter
const galaxyIdParam = Astro.url.searchParams.get("galaxy");

// Validate galaxy ID
if (!galaxyIdParam) {
  return Astro.redirect("/project/404?method=getGalaxyIdParam");
}

// Fetch galaxy from database
const galaxy = await getGalaxyById(galaxyIdParam);
if (!galaxy) {
  return Astro.redirect("/project/404?method=getGalaxyById");
}

// Fetch project from database
const project = await getProjectById(galaxy.projectLink);
if (!project) {
  return Astro.redirect("/project/404?method=getProjectById");
}

// Fetch maintainer user for author info
const maintainer = await getStarById(galaxy.maintainer);
let authorUri = "/star?id=unknown";
let authorName = "Unknown";
let maintainerSrc: string | undefined;

if (maintainer?.userId) {
  const maintainerAuthUser = await getAuthUserById(maintainer.userId);
  if (maintainerAuthUser) {
    authorUri = `/star?id=${maintainer._id || "unknown"}`;
    authorName =
      maintainerAuthUser.name ||
      maintainerAuthUser.username ||
      maintainerAuthUser.email?.split("@")[0] ||
      "Unknown";
    maintainerSrc = maintainerAuthUser.image;
  }
}

// Extract social links
const githubLink = project.socialLinks?.find((link) => link.type === "github");
const blockchainExplorerLink = project.socialLinks?.find(
  (link) => link.type === "blockchain-explorer",
);
const documentationLink = project.socialLinks?.find(
  (link) => link.type === "documentation",
);

// Place Mode: If the page is in place mode, the user can place their star on the web page.
const isPlaceMode = Astro.url.searchParams.get("place") === "true";

const galaxySpace = await getGalaxySpace(galaxyIdParam);

// Get authenticated user from middleware
const betterAuthUser = Astro.locals.user;
const authUser: AuthUser | null = betterAuthUser
  ? {
      id: betterAuthUser.id,
      email: betterAuthUser.email,
      emailVerified: betterAuthUser.emailVerified || false,
      username: (betterAuthUser as any).username as string | undefined,
      displayUsername: (betterAuthUser as any).displayUsername as
        | string
        | undefined,
      name: betterAuthUser.name,
      image: betterAuthUser.image
        ? (betterAuthUser.image as string)
        : undefined,
      createdAt: betterAuthUser.createdAt,
      updatedAt: betterAuthUser.updatedAt,
    }
  : null;

let currentUserData: UserStar | null = null;
let currentUserId: string | undefined;

if (authUser?.id) {
  const userStar = await getStarByUserId(authUser.id);
  if (userStar?._id) {
    currentUserId = userStar._id;
    const galaxyUserStar = await getUserStar(galaxyIdParam, userStar._id);
    if (galaxyUserStar) {
      currentUserData = {
        ...galaxyUserStar,
        draggable: isPlaceMode,
        galaxyId: galaxyIdParam,
      };
    } else {
      // Get auth user data for display
      const nickname =
        authUser.name ||
        authUser.username ||
        authUser.email?.split("@")[0] ||
        "User";
      currentUserData = {
        galaxyId: galaxyIdParam,
        nickname,
        src: authUser.image,
        alt: undefined,
        stars: userStar.stars || 0,
        sunshines: userStar.sunshines || 0,
        role: undefined, // Star type doesn't have role, will be set when user places star in galaxy
        uri: undefined,
        userId: userStar._id,
        draggable: isPlaceMode,
      };
    }
  }
}

const starsWithDraggable = galaxySpace.map((star) => ({
  ...star,
  draggable: isPlaceMode && star.userId === currentUserId,
}));

// Transform database models to ProjectInfoProps
const projectData: ProjectInfoProps = {
  title: galaxy.name,
  isInfluencer: false, // TODO: Determine from user data
  rating: {
    sunshines: galaxy.sunshines,
    stars: galaxy.stars,
  },
  forks: project.forkLines.length,
  likes: 0, // TODO: Add likes to galaxy model if needed
  isFollowing: false, // TODO: Check if current user is following
  originalProject: project.forkLines.length > 0 ? "Original project" : "",
  issue:
    project.forkLines.length > 0
      ? `Issue: ${project.forkLines[0].via.length} issues`
      : "",
  description: galaxy.description,
  license: project.license || "MIT License",
  balance: galaxy.donationAmount,
  cascadeBalance: 0, // TODO: Add cascade balance to galaxy model if needed
  totalAmount: 0, // TODO: Calculate from donations
  duration: "0 days", // TODO: Calculate from created time
  lastActivity: project.lastCommitUpdateTime
    ? Date.now() - project.lastCommitUpdateTime
    : 0,
  totalCommits: project.totalCommits || 0,
  commitsPerDay: "0 commits / day", // TODO: Calculate from commits
  openIssues: 0, // TODO: Add issues count to galaxy model
  closedIssues: 0, // TODO: Add closed issues count to galaxy model
  avgResponseTime: "N/A", // TODO: Calculate from issues
  author: {
    _id: maintainer?._id,
    userId: maintainer?.userId,
    src: maintainerSrc,
    children: authorName,
    icon: maintainerSrc,
    rating: undefined,
  } as any, // Type mismatch: ProfileLink (Star) doesn't match actual usage
  stars: starsWithDraggable,
  originalProjectUrl: "",
  followers: galaxy.users,
  createdTime: 0, // TODO: Add created time to galaxy model
  actions: [],
  projectGoal: 1000, // TODO: Add project goal to galaxy or project model
};
---

<GalaxyLayout
  active={MenuName.ProjectName}
  hideLinks={Object.keys(MenuName)}
  projectName={projectData.title}
  stars={projectData.stars}
  projectGoal={projectData.projectGoal}
  projectId={galaxyIdParam}
>
  <AllStarsContest
    slot="header-navbar"
    client:only="react"
    projectGoal={1000}
    currentStars={galaxy.stars}
    projectName={galaxy.name}
    projectUri={`/project?galaxy=${galaxyIdParam}`}
    contest={{
      title: "Galaxy Formation Contest",
      description:
        "Projects that reach their star goal become galaxies and compete for prizes",
      goal: projectData.projectGoal || 1000,
      prize: "10,000 tokens + Featured placement",
      endTime: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days from now
      position: 5,
      contestFromDate: new Date(Date.now() - 7 * 24 * 60 * 60 * 1000), // 7 days ago
      contestToDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000), // 30 days from now
    }}
  />
  <BackButton slot="left" client:load />

  <ProjectLandingHero
    slot="center"
    projectData={projectData}
    projectUri={`/project/issues?galaxy=${galaxyIdParam}`}
    githubUrl={githubLink?.uri}
    blockchainExplorerUrl={blockchainExplorerLink?.uri}
    documentationUrl={documentationLink?.uri}
    client:only="react"
  />
  {
    isPlaceMode && (
      <PlaceCtaPanel
        slot="center"
        client:only="react"
        userData={currentUserData}
      />
    )
  }
  {
    !isPlaceMode && (
      <ProjectCTAPanel
        slot="center"
        client:only="react"
        galaxyId={galaxyIdParam}
        projectName={projectData.title}
      />
    )
  }

  <ProjectGoalPanel
    slot="right"
    client:only="react"
    stars={projectData.stars}
    totalStars={projectData.rating.stars}
    totalSunshines={projectData.rating.sunshines}
    goalStars={100}
    projectGoal={projectData.projectGoal}
    goalDonations={projectData.balance * 10}
    projectName={projectData.title}
  />

  <!-- <HighlightedInteraction slot="right" /> -->
  <!-- <ProjectPeople slot="right" /> -->
  <!-- <IssueInfoPanel slot="right" /> -->
</GalaxyLayout>
