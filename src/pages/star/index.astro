---
export const prerender = false;
import GalaxyLayout from "@/layouts/GalaxyLayout.astro";
import { MenuName } from "@/components/navbar/WorkNavbar.astro";
import BackButton from "@/components/custom-ui/BackButton";
import GalaxyAutoZoom from "@/components/all-stars/GalaxyAutoZoom";
import ProfileWithBlogs from "@/components/user/ProfileWithBlogs";
import CreateBlogCTA from "@/components/blog/CreateBlogCTA";
import ConditionalSignOutButton from "@/components/auth/ConditionalSignOutButton";
import { getStarById, getStarByUserId } from "@/server-side/star";
import { getAuthUserById } from "@/server-side/auth";
import { getGalaxiesByMaintainer } from "@/server-side/galaxy";
import { getBlogsByAuthor } from "@/server-side/blog";
import { mockUserStars } from "@/types/mock-data";
import type { AuthUser } from "@/types/auth";

// Get user identifier from query params
const userIdParam = Astro.url.searchParams.get("id");
const userEmailParam = Astro.url.searchParams.get("email");

let user = null;

// Try to get star by ID or email
if (userIdParam) {
    console.log("star id param", userIdParam);
    user = await getStarById(userIdParam);
    console.log("star by id", user);
} else if (userEmailParam) {
    user = await getStarByUserId(userEmailParam);
    console.log("star by email", user);
} else {
    // Try to get current star from demo cookies (server-side fallback)
    const demoEmail = Astro.cookies.get("demo-email")?.value;
    if (demoEmail) {
        user = await getStarByUserId(demoEmail);
        console.log("star by demo email", user);
    } else {
        console.log("no star found");
    }
}

// If no user found, redirect to 404
if (!user) {
    return Astro.redirect("/star/404");
}

// Get user's galaxies (where user is maintainer)
const userGalaxies = await getGalaxiesByMaintainer(user._id!);

// Get user's blogs
const userBlogs = await getBlogsByAuthor(user._id!);

// Prepare galaxies for display in the virtual screen
const allGalaxies = userGalaxies.map((galaxy, index) => ({
    x: galaxy.x,
    y: galaxy.y,
    projectName: galaxy.name,
    projectId: galaxy._id?.toString() || "",
    galaxyData: galaxy,
    tags: galaxy.tags,
    leaderboardPosition: index + 1,
}));

// Calculate center position for user (average of their galaxies, or default to 0,0)
const userX =
    userGalaxies.length > 0
        ? userGalaxies.reduce((sum, g) => sum + g.x, 0) / userGalaxies.length
        : 0;
const userY =
    userGalaxies.length > 0
        ? userGalaxies.reduce((sum, g) => sum + g.y, 0) / userGalaxies.length
        : 0;

// Get auth user from locals (set by middleware)
const betterAuthUser = Astro.locals.user;
const authUser: AuthUser | null = betterAuthUser
    ? {
          id: betterAuthUser.id,
          email: betterAuthUser.email,
          emailVerified: betterAuthUser.emailVerified || false,
          username: (betterAuthUser as any).username as string | undefined,
          displayUsername: (betterAuthUser as any).displayUsername as
              | string
              | undefined,
          name: betterAuthUser.name,
          image: betterAuthUser.image
              ? (betterAuthUser.image as string)
              : undefined,
          createdAt: betterAuthUser.createdAt,
          updatedAt: betterAuthUser.updatedAt,
      }
    : null;

// Get auth user for the star being viewed
let starAuthUser: AuthUser | null = null;
let displayName = "User Profile";
if (user?.userId) {
    starAuthUser = await getAuthUserById(user.userId);
    if (starAuthUser) {
        displayName =
            starAuthUser.name ||
            starAuthUser.username ||
            starAuthUser.email?.split("@")[0] ||
            "User Profile";
    }
}
---

<GalaxyLayout
    active={MenuName.ProjectName}
    hideLinks={Object.keys(MenuName)}
    projectName={displayName}
    stars={mockUserStars}
    projectGoal={1000}
    projectX={userX}
    projectY={userY}
    projectGalaxies={allGalaxies}
>
    <BackButton slot="left" client:load />

    <ConditionalSignOutButton
        slot="right"
        starEmail={starAuthUser?.email}
        client:load
    />

    <ProfileWithBlogs
        slot="center"
        user={user}
        galaxies={userGalaxies}
        blogs={userBlogs}
        authUser={starAuthUser}
        client:only="react"
    />

    <CreateBlogCTA slot="center" authorId={user._id!} client:only="react" />

    <GalaxyAutoZoom client:only="react" galaxyX={userX} galaxyY={userY} />
</GalaxyLayout>

<style is:global>
    /* Hide scrollbars but allow scrolling */
    html,
    body {
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
    }

    html::-webkit-scrollbar,
    body::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
    }

    /* Hide scrollbars on all elements */
    * {
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
    }

    *::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
    }
</style>
