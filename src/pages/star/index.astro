---
export const prerender = false;
import GalaxyLayout from "@/layouts/GalaxyLayout.astro";
import { MenuName } from "@/components/navbar/WorkNavbar.astro";
import BackButton from "@/components/custom-ui/BackButton";
import GalaxyAutoZoom from "@/components/all-stars/GalaxyAutoZoom";
import StarProfileHero from "@/components/user/StarProfileHero";
import CreateBlogCTA from "@/components/blog/CreateBlogCTA";
import ConditionalSignOutButton from "@/components/auth/ConditionalSignOutButton";
import UserAccountPanel from "@/components/user/UserAccountPanel";
import { getStarById, getStarByUserId } from "@/server-side/star";
import { getAuthUserById } from "@/server-side/auth";
import { getGalaxiesByMaintainer } from "@/server-side/galaxy";
import { getBlogsByAuthor } from "@/server-side/blog";
import type { AuthUser } from "@/types/auth";

// Get user identifier from query params
const userIdParam = Astro.url.searchParams.get("id");
const userEmailParam = Astro.url.searchParams.get("email");

let user = null;

// Try to get star by ID or email
if (userIdParam) {
    console.log("star id param", userIdParam);
    user = await getStarById(userIdParam);
    console.log("star by id", user);
} else if (userEmailParam) {
    user = await getStarByUserId(userEmailParam);
    console.log("star by email", user);
}

// If no user found, redirect to 404
if (!user) {
    return Astro.redirect("/star/404");
}

// Get user's galaxies (where user is maintainer)
const userGalaxies = await getGalaxiesByMaintainer(user._id!);

// Get user's blogs
const userBlogs = await getBlogsByAuthor(user._id!);

// Prepare galaxies for display in the virtual screen with random positions
const allGalaxies = userGalaxies.map((galaxy, index) => {
    // Generate random x, y for virtual screen display
    // Avoid center area (middle 40% of screen width)
    const seed = galaxy._id
        ? galaxy._id
              .split("")
              .reduce((acc, char) => acc + char.charCodeAt(0), 0)
        : index;
    const randomX = ((seed * 9301 + 49297) % 233280) / 233280;
    const randomY = (((seed * 9301 + 49297) * 9301 + 49297) % 233280) / 233280;

    // Center area is 30% to 70% of screen width (avoiding middle 40%)
    // Place galaxies in left 30% or right 30% of screen
    const centerStart = 0.3; // 30% from left
    const centerEnd = 0.7; // 70% from left
    let x: number;

    if (randomX < 0.5) {
        // Place in left region (0% to 30%)
        x = randomX * centerStart * 1000;
    } else {
        // Place in right region (70% to 100%)
        x = (centerEnd + (randomX - 0.5) * (1 - centerEnd)) * 1000;
    }

    // Y can be anywhere in the screen height
    const y = randomY * 1000;

    return {
        x,
        y,
        projectName: galaxy.name,
        projectId: galaxy._id?.toString() || "",
        galaxyData: galaxy,
        tags: galaxy.tags,
        leaderboardPosition: index + 1,
    };
});

// Get auth user for the star being viewed
let starAuthUser: AuthUser | null = null;
let displayName = "User Profile";
if (user?.userId) {
    starAuthUser = await getAuthUserById(user.userId);
    if (starAuthUser) {
        displayName =
            starAuthUser.name ||
            starAuthUser.username ||
            starAuthUser.email?.split("@")[0] ||
            "User Profile";
    }
}
---

<GalaxyLayout
    active={MenuName.ProjectName}
    hideLinks={Object.keys(MenuName)}
    projectName={displayName}
    projectX={0}
    projectY={0}
    projectGalaxies={allGalaxies}
>
    <BackButton slot="left" client:load />

    <ConditionalSignOutButton
        slot="right"
        starEmail={starAuthUser?.email}
        client:load
    />

    <UserAccountPanel
        slot="right"
        user={user}
        authUser={starAuthUser}
        client:only="react"
    />

    <StarProfileHero
        slot="center"
        user={user}
        galaxies={userGalaxies}
        blogs={userBlogs}
        authUser={starAuthUser}
        client:only="react"
    />

    <CreateBlogCTA slot="center" authorId={user._id!} client:only="react" />

    <GalaxyAutoZoom client:only="react" galaxyX={0} galaxyY={0} />
</GalaxyLayout>

<style is:global>
    /* Hide scrollbars but allow scrolling */
    html,
    body {
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
    }

    html::-webkit-scrollbar,
    body::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
    }

    /* Hide scrollbars on all elements */
    * {
        scrollbar-width: none; /* Firefox */
        -ms-overflow-style: none; /* IE and Edge */
    }

    *::-webkit-scrollbar {
        display: none; /* Chrome, Safari, Opera */
    }
</style>
